# 查询服务模块

## 概述

查询服务模块是搜索引擎的核心交互层，负责接收用户查询请求、处理查询逻辑、联系索引模块获取结果、对结果进行排序并返回给用户。本模块将基于 FastAPI 实现 RESTful API 服务，支持各种查询类型和高级功能。

## 技术选择

### FastAPI

选择 FastAPI 作为后端框架的理由：

1. **高性能**: 基于 Starlette 和 Pydantic，性能接近 Node.js 和 Go
2. **异步支持**: 原生支持异步处理，适合 I/O 密集型应用
3. **自动文档**: 自动生成交互式 API 文档，便于开发和测试
4. **类型提示**: 使用 Python 类型注解，提高代码质量
5. **易于集成**: 易于与 Elasticsearch 等服务集成

## 查询服务功能

根据作业要求，实现以下六种查询服务：

### 1. 站内查询

基本的全文搜索功能：

-   接收用户输入的关键词
-   在网页索引中搜索匹配内容
-   结合 TF-IDF 和 PageRank 进行结果排序
-   返回排序后的结果列表

### 2. 文档查询

针对文档类型(PDF、Word 等)的元数据搜索：

-   在文档索引中搜索文档元数据(标题、作者等)
-   支持按文档类型过滤(doc/docx、pdf、xls/xlsx 等)
-   提供文档下载链接
-   显示文档元信息(文件大小、上传日期等)
-   不提供文档内容搜索和预览功能

### 3. 短语查询

支持精确短语匹配：

-   将用户输入视为一个完整短语
-   在索引中搜索完全匹配的内容
-   支持引号标记短语，如"南开大学"
-   区分普通关键词查询和短语查询

### 4. 通配查询

支持通配符和正则表达式查询：

-   支持星号(\*)代表多个字符
-   支持问号(?)代表单个字符
-   实现基于 Elasticsearch 查询 DSL 的通配查询
-   提供用户友好的通配符语法说明

### 5. 查询日志

记录和展示用户查询历史：

-   存储登录用户的查询历史到 SQLite
-   对于匿名用户，使用会话或本地存储记录临时历史
-   提供查询历史查看和重新执行功能
-   支持删除特定历史记录

### 6. 网页快照

提供网页历史版本查看功能：

-   在爬虫阶段保存网页快照(HTML 内容)
-   存储快照创建时间和 URL 信息
-   提供快照查看界面
-   支持在搜索结果中直接访问快照

## API 设计

设计 RESTful API 接口：

```
GET /api/search
    - 基本搜索接口
    - 参数：q(查询词), page, size, type(普通/短语/通配)

GET /api/search/document
    - 文档搜索接口
    - 参数：q, page, size, type(文档类型)

GET /api/history
    - 获取查询历史
    - 参数：user_id(可选), page, size

GET /api/snapshot/{url_id}
    - 获取网页快照
    - 参数：url_id, timestamp(可选)

POST /api/feedback
    - 提交搜索结果反馈
    - 参数：query_id, url, action(点击/收藏等)
```

## 查询处理流程

1. 接收用户查询请求
2. 查询参数预处理(分词、纠错、同义词扩展等)
3. 构造 Elasticsearch 查询 DSL
4. 执行查询获取原始结果
5. 结果后处理(排序、高亮、摘要生成等)
6. 返回处理后的结果

## 结果排序算法

结合多种因素进行结果排序：

1. **相关性得分**: Elasticsearch 基于 BM25 算法的相关性得分
2. **PageRank 值**: 基于网页链接分析的权重
3. **时效性**: 网页更新时间的影响
4. **用户偏好**: 基于用户历史行为的个性化调整
5. **域名权重**: 特定域名的加权(如主站权重高)

## 结果展示优化

1. **高亮显示**: 高亮匹配的关键词
2. **智能摘要**: 生成包含查询词的上下文摘要
3. **结果分组**: 按域名或类型对结果进行分组
4. **相关搜索**: 推荐相关的其他搜索词

## 性能优化

1. **查询缓存**: 缓存热门查询结果
2. **异步处理**: 使用异步编程模型
3. **分页优化**: 采用深度分页优化技术
4. **超时控制**: 设置查询超时机制

## 实现计划

1. 设计 API 接口和数据模型
2. 实现基本查询功能
3. 逐步添加高级查询功能
4. 开发查询日志和快照功能
5. 优化排序算法和结果展示
6. 性能测试和调优
