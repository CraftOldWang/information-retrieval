# 个性化查询模块

## 概述

个性化查询模块负责针对不同用户提供定制化的搜索结果，通过分析用户行为、兴趣和历史查询，对搜索结果进行重排序，提高用户搜索体验。此模块与用户系统紧密集成，是搜索引擎个性化功能的核心。

## 技术选择

1. **用户系统**: JWT 认证 + SQLite 存储用户信息
2. **行为分析**: 使用 Python 数据分析库(Pandas, NumPy)
3. **模型训练**: scikit-learn 用于简单模型训练
4. **数据存储**: SQLite 存储用户配置文件和行为数据

## 用户系统设计

### 用户注册与登录

实现基本的用户注册、登录和管理功能：

1. **用户注册**: 收集基本信息(学院、专业、年级等)
2. **账户管理**: 修改密码、更新个人信息
3. **权限控制**: 基于角色的访问控制
4. **会话管理**: 使用 JWT 令牌进行身份验证

### 用户数据模型

```json
{
    "user_id": "唯一标识符",
    "username": "用户名",
    "password_hash": "加密密码",
    "profile": {
        "college": "学院",
        "major": "专业",
        "grade": "年级",
        "interests": ["兴趣标签1", "兴趣标签2"]
    },
    "behavior": {
        "searches": [
            {
                "query": "查询词",
                "timestamp": "查询时间",
                "results_clicked": ["点击的URL"]
            }
        ],
        "clicks": [
            {
                "url": "点击的URL",
                "timestamp": "点击时间",
                "dwell_time": "停留时间(秒)"
            }
        ],
        "favorites": ["收藏的URL"]
    },
    "preferences": {
        "domains": {
            "nankai.edu.cn": 1.2,
            "cc.nankai.edu.cn": 1.5
        },
        "topics": {
            "计算机": 1.3,
            "数学": 0.8
        }
    }
}
```

## 用户行为分析

### 数据收集

收集以下用户行为数据：

1. **搜索历史**: 用户执行的查询
2. **点击行为**: 用户点击的搜索结果
3. **停留时间**: 用户在页面的停留时长
4. **收藏/标记**: 用户收藏或标记的内容
5. **反馈信息**: 用户对搜索结果的显式反馈

### 行为分析算法

基于收集的数据，构建用户兴趣模型：

1. **TF-IDF 向量**: 将用户查询和点击内容转换为向量
2. **主题建模**: 使用 LDA 提取用户关注的主题
3. **协同过滤**: 基于相似用户的行为推断兴趣
4. **时间衰减**: 考虑兴趣随时间的变化

## 个性化排序算法

将原始搜索结果根据用户模型进行重排序：

### 排序因子

1. **内容相关性**: 文档与查询的匹配度
2. **用户兴趣匹配**: 文档与用户兴趣的匹配度
3. **域名偏好**: 用户对特定域名的偏好
4. **历史交互**: 用户与类似内容的历史交互
5. **流行度**: 整体点击率和受欢迎程度

### 排序模型

将使用加权线性模型进行排序：

```
最终得分 = w1 * 相关性得分 + w2 * 兴趣匹配得分 + w3 * 域名偏好得分 + w4 * 历史交互得分 + w5 * 流行度得分
```

其中，权重(w1~w5)可以通过 A/B 测试进行优化。

## 冷启动问题解决

解决新用户无历史数据的冷启动问题：

1. **基础用户画像**: 根据注册信息创建初始画像
2. **基于角色的默认配置**: 根据学院/专业提供默认配置
3. **显式偏好设置**: 允许用户主动设置兴趣领域
4. **快速学习**: 加大初始几次搜索行为的权重

## 个性化 API 设计

```
GET /api/personalized/search
    - 个性化搜索接口
    - 参数：q(查询词), user_id, page, size

GET /api/user/preferences
    - 获取用户偏好设置
    - 参数：user_id

POST /api/user/preferences
    - 更新用户偏好设置
    - 参数：user_id, preferences(JSON)

GET /api/user/topics
    - 获取用户兴趣主题
    - 参数：user_id
```

## 隐私保护

确保用户数据安全和隐私：

1. **数据匿名化**: 分析时对用户数据进行匿名处理
2. **权限控制**: 严格控制数据访问权限
3. **明确同意**: 获取用户对数据收集的明确同意
4. **数据删除**: 提供数据删除功能

## 实现计划

1. 设计和开发用户系统
2. 实现用户行为数据收集机制
3. 开发用户兴趣建模算法
4. 实现个性化排序模型
5. 开发 API 接口和服务
6. 测试和优化个性化效果

## 评估指标

评估个性化排序的效果：

1. **点击率(CTR)**: 结果被点击的概率
2. **平均排名**: 被点击结果的平均排名
3. **用户满意度**: 基于显式反馈的满意度
4. **会话成功率**: 用户找到所需信息的比例
5. **平均查询次数**: 用户达成目标所需的查询次数
